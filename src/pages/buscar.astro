---
// Capa de Servicios e Integración con API de Búsqueda
import { searchNews } from '@/lib/api/search';
import { getCategories } from '@/lib/api/categories';

// Componentes de Layout y UI
import Layout from '@/layouts/Layout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import PageHero from '@/components/ui/PageHero.astro';

// Componentes de Funcionalidad (Features)
import NewsComponent from '@/components/features/news/NewsComponent';

// Captura de parámetros de búsqueda y navegación desde la URL
const query: string | null = Astro.url.searchParams.get('q');
const categoryFilter: string | null = Astro.url.searchParams.get('categoria');
const currentPage: number = parseInt(Astro.url.searchParams.get('page') || '1');

// Obtención de categorías disponibles para el filtrado lateral/superior
const allCategories = await getCategories();

// Inicialización de la estructura de estados para resultados (tipado explícito)
let products: any[] = [];
let pagination: any = undefined;
let hasSearched: boolean = false;

// Ejecución de la lógica de búsqueda basada en criterios (query o categoría)
if ((query && query.trim()) || categoryFilter) {
	hasSearched = true;
	try {
		// Envío de petición al servicio de búsqueda con parámetros de paginación
		const searchResults = await searchNews({
			query: query?.trim() || '',
			page: currentPage,
			pageSize: 12,
			categoryId: categoryFilter || undefined
		});
		products = searchResults.products;
		pagination = searchResults.pagination;
	} catch (error) {
		console.error('Error searching news:', error);
	}
}

// Resumen de estadísticas de búsqueda
const totalResults: number = pagination?.total ?? 0;
---

<Layout
	title={query ? `Buscar: ${query}` : 'Buscar Noticias'}
	booleanLayout={true}
	breadcrumbTitle="Búsqueda"
>
	<PageHero title="Centro de Búsqueda">
		{/* Buscador Integrado en Hero */}
		<form action="/buscar" method="GET" class="mx-auto mt-6 max-w-2xl px-4">
			<div class="relative flex items-center">
				<input
					type="text"
					name="q"
					value={query}
					placeholder="¿Qué estás buscando hoy?"
					class="focus:ring-secondary-500 w-full rounded-full border-0 bg-gray-50 py-4 pr-14 pl-6 text-gray-900 shadow-xl ring-1 ring-gray-300 ring-inset placeholder:text-gray-400 focus:ring-2 focus:ring-inset"
				/>
				<button
					type="submit"
					class="bg-secondary-600 hover:bg-secondary-700 absolute right-2 rounded-full p-2 text-white transition"
				>
					<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
					</svg>
				</button>
				{categoryFilter && <input type="hidden" name="categoria" value={categoryFilter} />}
			</div>
		</form>
	</PageHero>

	<main class="container-main pb-12">
		<Breadcrumb title="Búsqueda" className="mb-6 pt-8" />
		<!-- Filtros de Búsqueda -->
		<div class="mb-8 flex flex-wrap items-center gap-2 border-b border-gray-100 pb-4">
			<span class="mr-2 text-sm font-medium text-gray-500">Filtrar por:</span>
			<a
				href={`/buscar?q=${query || ''}`}
				class={`rounded-full border px-4 py-1.5 text-sm font-medium transition-colors ${
					!categoryFilter
						? 'bg-secondary-100 border-secondary-200 text-secondary-800'
						: 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
				}`}
			>
				Todos
			</a>
			{
				allCategories.map((cat: any) => (
					<a
						href={`/buscar?q=${query || ''}&categoria=${cat.slug}`}
						class={`rounded-full border px-4 py-1.5 text-sm font-medium transition-colors ${
							categoryFilter === cat.slug
								? 'border-secondary-200 bg-secondary-100 text-secondary-800'
								: 'border-gray-200 bg-white text-gray-600 hover:bg-gray-50'
						}`}
					>
						{cat.name}
					</a>
				))
			}
		</div>

		<!-- Resultados Stats -->
		<div class="mb-8">
			{
				hasSearched && (
					<p class="text-lg text-gray-600">
						{totalResults > 0 ? (
							<>
								Se encontraron <span class="text-secondary-700 font-semibold">{totalResults}</span>{' '}
								{totalResults === 1 ? 'resultado' : 'resultados'}
								{query && (
									<>
										{' '}
										para <span class="font-semibold">"{query}"</span>
									</>
								)}
								{categoryFilter && (
									<>
										{' '}
										en{' '}
										<span class="font-semibold capitalize">
											{categoryFilter.replace(/_/g, ' ')}
										</span>
									</>
								)}
							</>
						) : (
							<>
								No se encontraron resultados
								{query && (
									<>
										{' '}
										para <span class="font-semibold">"{query}"</span>
									</>
								)}
							</>
						)}
					</p>
				)
			}
		</div>

		<!-- Results -->
		{
			!hasSearched ? (
				<div class="rounded-xl bg-gray-50 p-12 text-center">
					<svg
						class="mx-auto mb-4 h-16 w-16 text-gray-400"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
						/>
					</svg>
					<h2 class="mb-2 text-2xl font-semibold text-gray-900">Realiza una búsqueda</h2>
					<p class="text-gray-600">
						Busca noticias por título, autor, rol o categoría usando el buscador del header
					</p>
				</div>
			) : products.length === 0 ? (
				<div class="rounded-xl bg-gray-50 p-12 text-center">
					<svg
						class="mx-auto mb-4 h-16 w-16 text-gray-400"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
						/>
					</svg>
					<h2 class="mb-2 text-2xl font-semibold text-gray-900">No se encontraron resultados</h2>
					<p class="mb-4 text-gray-600">Intenta con otros términos de búsqueda</p>
					<div class="text-sm text-gray-500">
						<p class="mb-2">Puedes buscar por:</p>
						<ul class="inline-flex flex-wrap gap-2">
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Título de la noticia</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Nombre del autor</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Rol del autor</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Categoría</li>
						</ul>
					</div>
				</div>
			) : (
				<>
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{products.map((product) => (
							<div class="group relative flex h-full flex-col overflow-hidden rounded-2xl bg-white shadow-md transition-all hover:shadow-xl">
								<div class="absolute inset-0 bg-linear-to-t from-black/40 to-transparent" />

								<div class="relative z-10 flex h-full grow flex-col p-4">
									<NewsComponent
										product={product}
										className="min-h-50 h-full"
										showContent={true}
										variant="compact"
										bgOverlay={true}
										highlightQuery={query || ''}
									/>
								</div>
							</div>
						))}
					</div>

					{pagination && pagination.pageCount && pagination.pageCount > 1 && (
						<div class="mt-12 flex justify-center gap-2">
							{currentPage > 1 && (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${currentPage - 1}`}
									class="rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
								>
									← Anterior
								</a>
							)}

							{Array.from({ length: pagination.pageCount }, (_, i) => i + 1).map((pageNum) => (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${pageNum}`}
									class={`rounded-lg px-4 py-2 text-sm font-medium shadow-sm ${
										pageNum === currentPage
											? 'bg-secondary-700 text-white'
											: 'bg-white text-gray-700 hover:bg-gray-50'
									}`}
								>
									{pageNum}
								</a>
							))}

							{currentPage < pagination.pageCount && (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${currentPage + 1}`}
									class="rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
								>
									Siguiente →
								</a>
							)}
						</div>
					)}
				</>
			)
		}
	</main>
</Layout>
