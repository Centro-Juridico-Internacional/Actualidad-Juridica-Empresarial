---
// Internal API imports
import { searchNews } from '@/lib/api/search';
import { getCategories } from '@/lib/api/categories';

// Astro components (layouts)
import Layout from '@/layouts/Layout.astro';

// React components (features)
import NewsComponent from '@/components/features/news/NewsComponent';

// Get params
const query: string | null = Astro.url.searchParams.get('q');
const categoryFilter: string | null = Astro.url.searchParams.get('categoria');
const currentPage: number = parseInt(Astro.url.searchParams.get('page') || '1');

// Fetch categories for filter
const allCategories = await getCategories();

// Initialize results structure with explicit types compatible with the return of searchNews
let products: any[] = [];
let pagination: any = undefined;
let hasSearched: boolean = false;

// Perform search logic
if ((query && query.trim()) || categoryFilter) {
	hasSearched = true;
	try {
        // searchNews returns { products: NewsArticle[], pagination: Pagination }
		const searchResults = await searchNews({ 
            query: query?.trim() || '', 
            page: currentPage, 
            pageSize: 12,
            categoryId: categoryFilter || undefined
        });
        products = searchResults.products;
        pagination = searchResults.pagination;
	} catch (error) {
		console.error('Error searching news:', error);
	}
}

// Stats
const totalResults: number = pagination?.total ?? 0;
---

<Layout title={query ? `Buscar: ${query}` : 'Buscar Noticias'} booleanLayout={false}>
    <!-- Hero Section -->
    <section class="relative flex h-[25vh] min-h-[220px] w-full items-center justify-center overflow-hidden bg-green-900 mb-8">
        <div class="absolute inset-0 opacity-20">
            <svg class="h-full w-full" width="100%" height="100%" viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <pattern id="dotPattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                        <circle cx="2" cy="2" r="1" fill="white" />
                    </pattern>
                </defs>
                <rect width="800" height="800" fill="url(#dotPattern)" />
            </svg>
        </div>
        <div class="container-main relative z-10 text-center">
            <h1 class="mb-4 text-3xl font-bold text-white md:text-4xl lg:text-5xl">
                Centro de Búsqueda
            </h1>
            
            {/* Buscador Integrado en Hero */}
            <form action="/buscar" method="GET" class="mx-auto mt-6 max-w-2xl px-4">
                <div class="relative flex items-center">
                    <input 
                        type="text" 
                        name="q" 
                        value={query}
                        placeholder="¿Qué estás buscando hoy?"
                        class="w-full rounded-full border-0 py-4 pl-6 pr-14 text-gray-900 shadow-xl ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-green-500"
                    />
                    <button type="submit" class="absolute right-2 rounded-full bg-green-600 p-2 text-white hover:bg-green-700 transition">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    {categoryFilter && <input type="hidden" name="categoria" value={categoryFilter} />}
                </div>
            </form>
        </div>
    </section>

	<main class="container-main pb-12">
		<!-- Filtros de Búsqueda -->
        <div class="mb-8 flex flex-wrap items-center gap-2 border-b border-gray-100 pb-4">
            <span class="text-sm font-medium text-gray-500 mr-2">Filtrar por:</span>
            <a 
                href={`/buscar?q=${query || ''}`}
                class={`rounded-full border px-4 py-1.5 text-sm font-medium transition-colors ${
                    !categoryFilter 
                    ? 'bg-green-100 border-green-200 text-green-800' 
                    : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                }`}
            >
                Todos
            </a>
            {allCategories.map((cat: any) => (
                <a 
                    href={`/buscar?q=${query || ''}&categoria=${cat.slug}`}
                    class={`rounded-full border px-4 py-1.5 text-sm font-medium transition-colors ${
                        categoryFilter === cat.slug
                        ? 'bg-green-100 border-green-200 text-green-800' 
                        : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                    }`}
                >
                    {cat.name}
                </a>
            ))}
        </div>

        <!-- Resultados Stats -->
		<div class="mb-8">
			{
				hasSearched && (
					<p class="text-lg text-gray-600">
						{totalResults > 0 ? (
							<>
								Se encontraron <span class="font-semibold text-green-700">{totalResults}</span>{' '}
								{totalResults === 1 ? 'resultado' : 'resultados'}
                                {query && <> para <span class="font-semibold">"{query}"</span></>}
                                {categoryFilter && <> en <span class="font-semibold capitalize">{categoryFilter.replace(/_/g, ' ')}</span></>}
							</>
						) : (
							<>
								No se encontraron resultados{query && <> para <span class="font-semibold">"{query}"</span></>}
							</>
						)}
					</p>
				)
			}
		</div>

		<!-- Results -->
		{
			!hasSearched ? (
				<div class="rounded-xl bg-gray-50 p-12 text-center">
					<svg
						class="mx-auto mb-4 h-16 w-16 text-gray-400"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
						/>
					</svg>
					<h2 class="mb-2 text-2xl font-semibold text-gray-900">Realiza una búsqueda</h2>
					<p class="text-gray-600">
						Busca noticias por título, autor, rol o categoría usando el buscador del header
					</p>
				</div>
			) : products.length === 0 ? (
				<div class="rounded-xl bg-gray-50 p-12 text-center">
					<svg
						class="mx-auto mb-4 h-16 w-16 text-gray-400"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
						/>
					</svg>
					<h2 class="mb-2 text-2xl font-semibold text-gray-900">No se encontraron resultados</h2>
					<p class="mb-4 text-gray-600">Intenta con otros términos de búsqueda</p>
					<div class="text-sm text-gray-500">
						<p class="mb-2">Puedes buscar por:</p>
						<ul class="inline-flex flex-wrap gap-2">
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Título de la noticia</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Nombre del autor</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Rol del autor</li>
							<li class="rounded-full bg-white px-3 py-1 shadow-sm">Categoría</li>
						</ul>
					</div>
				</div>
			) : (
				<>
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{products.map((product) => (
							<div class="group relative overflow-hidden rounded-2xl bg-white shadow-md transition-all hover:shadow-xl">
								<div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent" />

								<div class="relative z-10 p-4">
									<NewsComponent
										product={product}
										className="min-h-[200px] "
										showContent={true}
										variant="compact"
										bgOverlay={true}
                                        highlightQuery={query || ''}
									/>
								</div>
							</div>
						))}
					</div>

					{pagination && pagination.pageCount && pagination.pageCount > 1 && (
						<div class="mt-12 flex justify-center gap-2">
							{currentPage > 1 && (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${currentPage - 1}`}
									class="rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
								>
									← Anterior
								</a>
							)}

							{Array.from({ length: pagination.pageCount }, (_, i) => i + 1).map((pageNum) => (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${pageNum}`}
									class={`rounded-lg px-4 py-2 text-sm font-medium shadow-sm ${
										pageNum === currentPage
											? 'bg-green-700 text-white'
											: 'bg-white text-gray-700 hover:bg-gray-50'
									}`}
								>
									{pageNum}
								</a>
							))}

							{currentPage < pagination.pageCount && (
								<a
									href={`/buscar?q=${encodeURIComponent(query || '')}&categoria=${categoryFilter || ''}&page=${currentPage + 1}`}
									class="rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
								>
									Siguiente →
								</a>
							)}
						</div>
					)}
				</>
			)
		}
	</main>
</Layout>
