---
// Librería para el procesamiento de contenido en formato Markdown
import { marked } from 'marked';

// Capa de Servicios y Tipos de Datos
import { getNewsBySlug } from '@/lib/api/news';
import type { NewsArticle } from '@/lib/api/news';

// Integración de Meta-Tags SEO y Datos Estructurados (Schema.org)
import { processSEOMetadata } from '@/lib/seo';
import {
	generateNewsArticleSchema,
	generateBreadcrumbSchema,
	generateVideoSchema,
	getSchemaScript,
	validateNewsArticleSchema,
	SITE_CONFIG
} from '@/lib/schemaOrg';

// Componentes de Layout
import Layout from '@/layouts/Layout.astro';

// Componentes de Interfaz de Usuario (UI)
import SmartRelatedNews from '@/components/ui/SmartRelatedNews.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';

// Componentes de Funcionalidad y Multimedia (Features)
import YouTubeLite from '@/components/features/media/YouTubeLite';
import ArticleAudioPlayer from '@/components/features/media/ArticleAudioPlayer';

import SocialShare from '@/components/features/social/SocialShare';
import ReadingProgressBar from '@/components/features/ui/ReadingProgressBar';

// Captura e identificación de la noticia desde los parámetros de la ruta (slug)
const { newsId } = Astro.params as { newsId: string };
if (!newsId) throw Astro.redirect('/404');

// Obtención del artículo completo desde el servicio de datos (Optimizado por slug)
const product: NewsArticle | null = await getNewsBySlug(newsId);
if (!product) throw Astro.redirect('/404');

// Lógica de cálculo del tiempo estimado de lectura (Basado en recuento de palabras)
const countWords = (text: any) => {
	if (!text || typeof text !== 'string') return 0;
	return text.split(/\s+/).length;
};

// Extracción de Texto Plano para el Reproductor de Audio (Accesibilidad)
// Se eliminan símbolos markdown y enlaces para una lectura fluida del sintetizador.
const getPlainText = (text: any) => {
	if (!text || typeof text !== 'string') return '';
	// Limpiador básico de formato Markdown
	return text
		.replace(/[#*`_~]/g, '') // Eliminar símbolos comunes
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Reemplazar enlaces por su texto ancla
		.trim();
};

const words = countWords(product.content);
const plainText = getPlainText(product.content);
const readingTime = Math.ceil(words / 200); // Promedio de 200 palabras por minuto

// Preparación de Meta-Descripción SEO: Extrae los primeros 160 caracteres del texto limpio.
const metaDescription = plainText.slice(0, 157) + (plainText.length > 157 ? '...' : '');

// Generación de URL interna para el perfil del autor
const authorSlug: string = product.authorName
	? `/autores/${product.authorName.toLowerCase().replace(/\s+/g, '_')}`
	: '#';

// Identificación de origen para la generación de URLs absolutas (Necesario para Schema.org)
const { origin, href } = Astro.url;

// ============================================
// SCHEMA.ORG IMPLEMENTATION - COMPLETO
// ============================================

// 1. NewsArticle Schema (mejorado)
const newsArticleSchema = generateNewsArticleSchema(
	{
		headline: product.title,
		description: metaDescription,
		//@ts-ignore
		image: product.image || undefined,
		datePublished: product.publishedAt || new Date().toISOString(),
		dateModified: product.updatedAt || product.publishedAt || new Date().toISOString(),
		author: product.authorName
			? {
					name: product.authorName,
					url: `${origin}${authorSlug}`,
					...(product.authorAvatar && {
						image: {
							url: product.authorAvatar
						}
					})
				}
			: undefined,
		publisher: {
			name: SITE_CONFIG.name,
			logo: SITE_CONFIG.logo,
			url: SITE_CONFIG.url
		},
		mainEntityOfPage: href,
		articleBody: plainText.slice(0, 5000),
		keywords: product.categories.slice(0, 5),
		wordCount: words
	},
	origin
);

// Validar schema para Google Rich Results
const newsSchemaValidation = validateNewsArticleSchema(newsArticleSchema);

// 2. BreadcrumbList Schema
const breadcrumbs = [
	{ url: origin, name: 'Inicio' },
	{ url: `${origin}/noticia`, name: 'Noticias' },
	...product.categories.map((cat: string) => ({
		url: `${origin}/categorias/${cat.toLowerCase().replace(/\s+/g, '-')}`,
		name: cat
	})),
	{ url: href, name: product.title }
];

const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs, origin);

// 3. Video Schema (opcional, si hay YouTube URL)
let videoSchema = null;
if (product.youtubeUrl) {
	videoSchema = generateVideoSchema(
		{
			name: product.title,
			description: metaDescription,
			youtubeUrl: product.youtubeUrl,
			publishedAt: product.publishedAt || new Date().toISOString(),
			thumbnailUrl: product.image || undefined
		},
		origin
	);
}

// La estrategia ISR se orquesta mediante el modo 'hybrid' de la plataforma.
---

<!-- Schema.org JSON-LD Scripts --><!-- 1. NewsArticle (Obligatorio) -->
<Fragment set:html={getSchemaScript(newsArticleSchema)} />

<!-- 2. BreadcrumbList (Altamente recomendado) -->
<Fragment set:html={getSchemaScript(breadcrumbSchema)} />

<!-- 3. VideoObject (Si aplica) -->
{videoSchema && <Fragment set:html={getSchemaScript(videoSchema)} />}

<Layout
	title={product.title}
	booleanLayout={true}
	breadcrumbTitle={product.title}
	description={metaDescription}
	ogImage={product.image || undefined}
	ogImageWidth={1200}
	ogImageHeight={630}
	ogType="article"
	publishedAt={product.publishedAt || undefined}
	updatedAt={product.updatedAt || undefined}
	authorName={product.authorName || undefined}
	authorUrl={`${origin}${authorSlug}`}
>
	<ReadingProgressBar client:load targetId="news-article-content" />

	<article id="news-article-content" class="animate-fadeIn">
		<!-- Hero Section -->
		<div class="relative h-[50vh] min-h-100 w-full overflow-hidden">
			<img
				src={product.image}
				alt={`${product.title} imagen`}
				class="absolute inset-0 h-full w-full object-cover"
				loading="eager"
				decoding="async"
				fetchpriority="high"
			/>
			<div class="absolute inset-0 bg-linear-to-t from-black/70 via-black/60 to-black/10"></div>
			<div class="container-main relative flex h-full items-end pb-16">
				<div class="animate-slideUp max-w-3xl">
					<div class="mb-6 flex flex-wrap gap-3">
						{
							product.categories.map((cat: string) => (
								<a
									href={`/categorias/${cat.toLowerCase()}`}
									class="bg-secondary-500/90 hover:bg-secondary-600 rounded-full px-4 py-1.5 text-sm font-medium text-white backdrop-blur-sm transition-all"
								>
									{cat.charAt(0).toUpperCase() + cat.slice(1)}
								</a>
							))
						}
						<span
							class="rounded-full bg-black/40 px-4 py-1.5 text-sm font-medium text-white backdrop-blur-sm"
						>
							⏱️ {readingTime} min lectura
						</span>
					</div>
					<h1
						class="text-2xl leading-tight font-bold wrap-break-word text-white sm:text-3xl md:text-3xl lg:text-3xl xl:text-4xl"
					>
						{product.title}
					</h1>
				</div>
			</div>
		</div>

		<!-- Contenido Principal -->
		<div class="container-main px-4 py-12 sm:px-6 lg:px-0">
			<Breadcrumb title={product.title} className="mb-8" />
			<div class="grid gap-8 lg:grid-cols-[1fr_1fr_0.7fr]">
				<!-- Artículo -->
				<div class="lg:col-span-2">
					<!-- Meta información -->
					<div
						class="mb-8 flex flex-col justify-between gap-6 border-b border-gray-100 pb-6 sm:flex-row sm:items-center"
					>
						<a href={authorSlug} class="group flex items-center gap-3">
							<img
								src={product.authorAvatar}
								alt={product.authorName}
								class="ring-secondary-100 group-hover:ring-secondary-300 h-12 w-12 rounded-full ring-2 transition-all"
								loading="lazy"
							/>
							<div>
								<p class="group-hover:text-secondary-600 font-medium text-gray-900">
									{product.authorName} - {product.authorRole ?? 'Autor'}
								</p>
								<p class="text-sm text-gray-500">
									{product.day} • {product.time}
								</p>
							</div>
						</a>

						<div class="no-print">
							<SocialShare
								client:visible
								url={`${origin}/noticia/${newsId}`}
								title={product.title}
							/>
						</div>
					</div>

					<div class="mb-6 flex justify-end">
						<ArticleAudioPlayer client:load title={product.title} content={plainText} />
					</div>
					<!-- Contenido -->
					<div
						class="prose prose-lg prose-headings:font-bold prose-headings:text-gray-900 prose-p:text-gray-700 prose-a:text-secondary-600 prose-a:no-underline hover:prose-a:text-secondary-700 hover:prose-a:underline prose-strong:text-gray-900 prose-blockquote:border-secondary-600 prose-blockquote:bg-secondary-50/50 prose-blockquote:px-8 prose-blockquote:py-4 prose-blockquote:not-italic max-w-none overflow-hidden rounded-2xl bg-gray-50 px-4 py-6 wrap-break-word sm:px-6"
						set:html={marked.parse(product.content as string, { gfm: true, breaks: true })}
					/>

					<!-- Video de YouTube -->
					{
						product.youtubeUrl && (
							<div class="mt-12 overflow-hidden rounded-2xl shadow-lg">
								<YouTubeLite videoid={product.youtubeUrl} title={product.title} client:visible />
							</div>
						)
					}
				</div>

				<!-- Sidebar -->
				<aside class="space-y-6 lg:sticky lg:top-8">
					<div class="rounded-2xl bg-white p-6 shadow-md">
						<h2 class="mb-6 text-xl font-bold text-gray-900">
							{product.categories.length > 0 ? 'Noticias relacionadas' : 'Últimas noticias'}
						</h2>
						<SmartRelatedNews
							currentSlug={newsId}
							currentTitle={product.title}
							categorySlugs={product.categories.map((c) => c.toLowerCase())}
							limit={4}
						/>
					</div>
				</aside>
			</div>
		</div>
	</article>
</Layout>

<style>
	/* Animaciones */
	@keyframes fadeIn {
		from {
			opacity: 0;
		}
		to {
			opacity: 1;
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-fadeIn {
		animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
	}

	.animate-slideUp {
		animation: slideUp 0.9s cubic-bezier(0.4, 0, 0.2, 1) forwards;
	}

	/* Mejoras en la prosa */
	:global(.prose img) {
		border-radius: 0.75rem;
		box-shadow:
			0 4px 6px -1px rgb(0 0 0 / 0.1),
			0 2px 4px -2px rgb(0 0 0 / 0.1);
		transition-property: transform;
		transition-duration: 300ms;
	}

	:global(.prose blockquote) {
		border-radius: 0.5rem;
	}
	:global(.prose a) {
		color: var(--color-secondary-600);
		text-decoration: none;
	}
	:global(.prose a:hover) {
		color: var(--color-secondary-700);
		text-decoration: underline;
	}

	/* Asegurar que el contenido markdown sea 100% responsivo */
	:global(.prose) {
		max-width: 100%;
		overflow-x: hidden;
	}

	:global(.prose img, .prose video) {
		max-width: 100% !important;
		height: auto !important;
	}
	:global(.prose iframe) {
		max-width: 100% !important;
		height: 300px !important;
	}

	:global(.prose table) {
		display: block;
		overflow-x: auto;
		white-space: nowrap;
	}

	:global(.prose pre, .prose code) {
		white-space: pre-wrap;
		word-break: break-all;
	}
</style>
