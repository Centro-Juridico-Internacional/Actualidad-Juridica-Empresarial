---
// External imports
import { BlocksRenderer } from '@strapi/blocks-react-renderer';

// Internal API imports
import { getNewsBySlug } from '@/lib/api/news';
import type { NewsArticle } from '@/lib/api/news';

// Astro components (layouts)
import Layout from '@/layouts/Layout.astro';

// Astro components (UI)
import LatestNews from '@/components/ui/LatestNews.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';

// React components (features)
import YouTubeLite from '@/components/features/media/YouTubeLite';

import SocialShare from '@/components/features/social/SocialShare';
import ReadingProgressBar from '@/components/features/ui/ReadingProgressBar';

// Get news ID from route params
const { newsId } = Astro.params as { newsId: string };
if (!newsId) throw Astro.redirect('/404');

// Fetch specific news article by slug (optimized)
const product: NewsArticle | null = await getNewsBySlug(newsId);
if (!product) throw Astro.redirect('/404');

// Calculate Reading Time
const countWords = (blocks: any[]) => {
	let text = '';
	blocks?.forEach((block) => {
		if (block.type === 'paragraph' || block.type === 'heading') {
			block.children?.forEach((child: any) => {
				if (child.type === 'text') text += child.text + ' ';
			});
		}
	});
	return text.split(/\s+/).length;
};

const words = countWords(product.contenido);
const readingTime = Math.ceil(words / 200); // 200 words per minute average

// Generate author slug for navigation
const autorSlug: string = product.autorName
	? `/autores/${product.autorName.toLowerCase().replace(/\s+/g, '_')}`
	: '#';

// Generate Schema.org JSON-LD
const { origin } = Astro.url;
const schema = {
	'@context': 'https://schema.org',
	'@type': 'NewsArticle',
	headline: product.titulo,
	image: [product.image],
	datePublished: new Date().toISOString(), // Idealmente usar product.publishedAt si existe
	dateModified: new Date().toISOString(),
	author: [
		{
			'@type': 'Person',
			name: product.autorName || 'Centro Jurídico Internacional',
			url: `${origin}${autorSlug}`
		}
	],
	publisher: {
		'@type': 'Organization',
		name: 'Centro Jurídico Internacional',
		logo: {
			'@type': 'ImageObject',
			url: `${origin}/header/logo.svg`
		}
	}
};

// ISR maneja el cache automáticamente en modo hybrid
---
<script type="application/ld+json" set:html={JSON.stringify(schema)} />

<Layout title={product.titulo} booleanLayout={true} breadcrumbTitle={product.titulo}>
	<ReadingProgressBar client:load targetId="news-article-content" />

	<article id="news-article-content" class="animate-fadeIn">
		<!-- Hero Section -->
		<div class="relative h-[50vh] min-h-[400px] w-full overflow-hidden">
			<img
				src={product.image}
				alt={`${product.titulo} imagen`}
				class="absolute inset-0 h-full w-full object-cover"
				loading="eager"
				decoding="async"
				fetchpriority="high"
			/>
			<div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/60 to-black/10"></div>
			<div class="container-main relative flex h-full items-end pb-16">
				<div class="animate-slideUp max-w-3xl">
					<div class="mb-6 flex flex-wrap gap-3">
						{
							product.categorias.map((cat: string) => (
								<a
									href={`/categorias/${cat.toLowerCase()}`}
									class="rounded-full bg-green-500/90 px-4 py-1.5 text-sm font-medium text-white backdrop-blur-sm transition-all hover:bg-green-600"
								>
									{cat.charAt(0).toUpperCase() + cat.slice(1)}
								</a>
							))
						}
						<span class="rounded-full bg-black/40 px-4 py-1.5 text-sm font-medium text-white backdrop-blur-sm">
							⏱️ {readingTime} min lectura
						</span>
					</div>
					<h1
						class="text-xl leading-tight font-bold break-words text-white md:text-2xl lg:text-3xl xl:text-4xl"
					>
						{product.titulo}
					</h1>
				</div>
			</div>
		</div>

		<!-- Contenido Principal -->
		<div class="container-main py-12">
			<Breadcrumb title={product.titulo} className="mb-8" />
			<div class="grid gap-8 lg:grid-cols-[1fr_1fr_0.7fr]">
				<!-- Artículo -->
				<div class="lg:col-span-2">
					<!-- Meta información -->
					<div class="mb-8 flex flex-col justify-between gap-6 border-b border-gray-100 pb-6 sm:flex-row sm:items-center">
						<a href={autorSlug} class="group flex items-center gap-3">
							<img
								src={product.autorAvatar}
								alt={product.autorName}
								class="h-12 w-12 rounded-full ring-2 ring-green-100 transition-all group-hover:ring-green-300"
								loading="lazy"
							/>
							<div>
								<p class="font-medium text-gray-900 group-hover:text-green-600">
									{product.autorName}
								</p>
								<p class="text-sm text-gray-500">
									{product.dia} • {product.hora}
								</p>
							</div>
						</a>

						<div class="no-print">
							<SocialShare 
								client:visible 
								url={`${origin}/noticia/${newsId}`} 
								title={product.titulo} 
							/>
						</div>
					</div>

					<!-- Contenido -->
					<div
						class="prose prose-lg prose-headings:font-bold prose-headings:text-gray-900 prose-p:text-gray-700 prose-a:text-green-600 prose-a:no-underline hover:prose-a:text-green-700 hover:prose-a:underline prose-strong:text-gray-900 prose-blockquote:border-green-600 prose-blockquote:bg-green-50/50 prose-blockquote:px-8 prose-blockquote:py-4 prose-blockquote:not-italic max-w-none rounded-2xl bg-gray-50 px-6 py-6"
					>
						<BlocksRenderer content={product.contenido} />
					</div>

					<!-- Video de YouTube -->
					{
						product.UrlYoutube && (
							<div class="mt-12 overflow-hidden rounded-2xl shadow-lg">
								<YouTubeLite videoid={product.UrlYoutube} title={product.titulo} client:visible />
							</div>
						)
					}
				</div>

				<!-- Sidebar -->
				<aside class="space-y-6 lg:sticky lg:top-8">
					<div class="rounded-2xl bg-white p-6 shadow-md">
						<h2 class="mb-6 text-xl font-bold text-gray-900">
							{product.categorias.length > 0 ? "Noticias relacionadas" : "Últimas noticias"}
						</h2>
						<LatestNews 
							layout="vertical" 
							currentSlug={newsId} 
							categorySlugs={product.categorias.map(c => c.toLowerCase())}
							limit={4} 
						/>
					</div>
				</aside>
			</div>
		</div>
	</article>
</Layout>

<style>
	/* Animaciones */
	@keyframes fadeIn {
		from {
			opacity: 0;
		}
		to {
			opacity: 1;
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-fadeIn {
		animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
	}

	.animate-slideUp {
		animation: slideUp 0.9s cubic-bezier(0.4, 0, 0.2, 1) forwards;
	}

	/* Mejoras en la prosa */
	:global(.prose img) {
		border-radius: 0.75rem;
		box-shadow:
			0 4px 6px -1px rgb(0 0 0 / 0.1),
			0 2px 4px -2px rgb(0 0 0 / 0.1);
		transition-property: transform;
		transition-duration: 300ms;
	}
	:global(.prose img:hover) {
		transform: scale(1.02);
	}

	:global(.prose blockquote) {
		border-radius: 0.5rem;
	}
</style>
