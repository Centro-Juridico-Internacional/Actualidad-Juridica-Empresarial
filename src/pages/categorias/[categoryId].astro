---
import YouTubeLite from '@/components/home/global/YouTubeLite';
import Layout from '@/layouts/Layout.astro';
import { getNews } from '@/lib/get-news';
import { BlocksRenderer } from '@strapi/blocks-react-renderer';

const { categoryId } = Astro.params;
if (!categoryId) throw Astro.redirect('/404');

const { products } = await getNews({ categoryId });

// Función para truncar el contenido a 100 palabras (texto plano)
function truncateBlocks(blocks: any[], maxWords: number) {
	let wordCount = 0;
	let truncatedBlocks = [];
	let truncated = false;

	for (const block of blocks) {
		if (block.type === 'paragraph' && block.children && Array.isArray(block.children)) {
			let newChildren = [];
			for (const child of block.children) {
				const words = (child.text || '').split(/\s+/);
				if (wordCount + words.length <= maxWords) {
					newChildren.push(child);
					wordCount += words.length;
				} else {
					const remaining = maxWords - wordCount;
					if (remaining > 0) {
						const truncatedText = words.slice(0, remaining).join(' ');
						newChildren.push({ ...child, text: truncatedText });
						wordCount += remaining;
					}
					truncated = true;
					break;
				}
			}
			if (newChildren.length > 0) {
				truncatedBlocks.push({ ...block, children: newChildren });
			}
			if (truncated) break;
		} else {
			truncatedBlocks.push(block);
		}
	}
	return { blocks: truncatedBlocks, truncated };
}
---

<Layout title={categoryId} booleanLayout={true}>
	<section class="mx-auto max-w-6xl px-4 py-8">
		<h2 class="mb-8 text-center text-4xl font-extrabold tracking-tight text-gray-800 capitalize">
			Noticias de {categoryId}
		</h2>
		<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
			{
				products.map((product: any) => {
					const { blocks, truncated } = truncateBlocks(product.contenido, 30);
					return (
						<article class="flex flex-col overflow-hidden rounded-3xl border border-gray-100 bg-white shadow-lg transition-all duration-300 hover:shadow-2xl">
							<img
								src={product.image}
								alt={`${product.titulo} imagen`}
								class="h-52 w-full object-cover"
							/>
							<div class="flex flex-1 flex-col p-6">
								<h1 class="mb-2 text-xl font-bold text-gray-900">{product.titulo}</h1>
								<div class="mb-4 text-justify text-sm text-gray-700">
									<BlocksRenderer content={blocks} />
									{truncated && (
										<a
											href={`/noticia/${product.slug}`}
											class="text-center text-blue-600 hover:underline"
										>
											...click para leer más
										</a>
									)}
								</div>
								<div class="mb-4 flex items-center gap-2">
									<span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-center text-xs font-semibold text-blue-800">
										{product.dia} &bull; {product.hora}
									</span>
									{product.categorias.map((item: string) => (
										<a
											href={item}
											class="inline-block rounded-full bg-green-100 px-2 py-0.5 text-center text-xs font-medium text-green-700 transition hover:bg-green-200"
										>
											{item}
										</a>
									))}
								</div>
								{product.UrlYoutube && (
									<div class="mb-4">
										<YouTubeLite videoid={product.UrlYoutube} title={product.titulo} client:load />
									</div>
								)}
								<div class="mt-auto flex items-center border-t border-gray-100 pt-4">
									<img src={product.autorAvatar} alt="Autor" class="mr-3 h-8 w-8 rounded-full" />
									<span class="text-sm text-gray-600">{product.autorName}</span>
								</div>
							</div>
						</article>
					);
				})
			}
		</div>
	</section></Layout
>
