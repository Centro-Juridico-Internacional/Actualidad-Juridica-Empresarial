---
// Capa de Servicios y API
import { getNews } from '@/lib/api/news';
import type { NewsArticle } from '@/lib/api/news';

// Componentes de Layout
import Layout from '@/layouts/Layout.astro';

// Componentes de Interfaz de Usuario (UI)
import NewsCard from '@/components/ui/NewsCard.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';

// Captura del ID del autor desde los parámetros de la ruta dinâmica
const { authorId } = Astro.params as { authorId: string };
if (!authorId) throw Astro.redirect('/404');

// Obtención del listado de noticias para filtrado local (Optimización de autor)
const { products }: { products: NewsArticle[] } = await getNews({ categoryId: '' });

// Lógica de filtrado de artículos asociados al autor específico
const authorNews: NewsArticle[] = products.filter((item: NewsArticle) => {
	const slug: string = (item.authorName || '').toLowerCase().replace(/\s+/g, '_');
	return slug === authorId;
});

if (authorNews.length === 0) throw Astro.redirect('/404');

// Función de utilidad para capitalizar cada palabra
const capitalizeWords = (str: string): string => {
	return str
		.split(' ')
		.map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
		.join(' ');
};

// Generar nombre de autor legible a partir del slug (guiones bajos a espacios)
const authorName: string = capitalizeWords(authorId.replace(/_/g, ' '));

// ISR maneja el cache automáticamente en modo hybrid
---

<Layout
	title={`Noticias de ${authorName}`}
	booleanLayout={true}
	breadcrumbTitle={`Noticias de ${authorName}`}
>
	<div class="from-secondary-50/50 min-h-screen bg-linear-to-b to-white">
		<section class="container-main py-16">
			<div class="relative mb-12 text-center">
				<h2 class="text-4xl font-extrabold tracking-tight text-gray-900 sm:text-5xl">
					<span class="relative inline-block">
						Noticias de <span class="text-secondary-600 inline-block">{authorName}</span>
						<span
							class="bg-secondary-500 absolute -bottom-2 left-0 h-1 w-full transform transition-transform duration-300 ease-out"
							style="transform-origin: center;"></span>
					</span>
				</h2>
				<p class="mt-4 text-lg text-gray-600">
					Descubre los últimos artículos y análisis de nuestro experto colaborador
				</p>
			</div>

			<Breadcrumb title={`Noticias de ${authorName}`} className="mt-8 mb-6" />

			<div class="grid items-stretch gap-8 sm:grid-cols-2 lg:grid-cols-3">
				{
					authorNews.map((product: any) => (
						<div class="group h-full transform transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl">
							<NewsCard product={product} truncateWords={30} className="h-full" />
						</div>
					))
				}
			</div>

			{
				authorNews.length === 0 && (
					<div class="flex h-64 items-center justify-center rounded-lg bg-gray-50 text-center">
						<p class="text-lg text-gray-600">No se encontraron artículos para este autor.</p>
					</div>
				)
			}
		</section>
	</div>
</Layout>
