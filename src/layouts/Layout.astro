---
// Estilos Globales y Fuentes
import '@/styles/global.css';
import '@fontsource-variable/noto-sans-jp';

// Importaciones Externas - Core de Astro
import { ClientRouter } from 'astro:transitions';

// Importaciones Externas - Vercel Analytics & Insights
import Analytics from '@vercel/analytics/astro';
import SpeedInsights from '@vercel/speed-insights/astro';

// Componentes de Astro (Estructura de Layout)
import Header from '@/layouts/Header.astro';
import Footer from '@/layouts/Footer.astro';
import ScrollToTop from '@/components/features/ui/ScrollToTop.tsx';
import SideButtons from '@/components/features/ui/SideButtons.astro';

// Helpers de SEO
import type { LayoutSEOProps } from '@/lib/seo';
import { ensureAbsoluteUrl, processSEOMetadata } from '@/lib/seo';

// Helpers de Schema.org (Datos Estructurados JSON-LD)
import {
	generateOrganizationSchema,
	generateWebSiteSchema,
	getSchemaScript,
	SITE_CONFIG
} from '@/lib/schemaOrg';
import WhatsApp from '@/components/ui/WhatsApp.astro';

// Interfaz de Propiedades (Contrato del Componente)
// Extiende LayoutSEOProps para garantizar tipado estricto en SEO
interface Props extends LayoutSEOProps {
	/** Controla si se muestra el Header completo o versión simplificada */
	booleanLayout: boolean;
}

// Desestructuración de propiedades con tipado explícito
const {
	title,
	booleanLayout,
	description,
	ogImage,
	ogImageWidth,
	ogImageHeight,
	ogType = 'website',
	publishedAt,
	updatedAt,
	authorName,
	authorUrl
}: Props = Astro.props;

// Lógica obtención de URL dinámica
// - origin: dominio actual (para canonicals y OG:URL absolutas)
// - href: URL completa de la página actual
const { origin, href } = Astro.url;

// Procesamiento de metadatos SEO con validación
// Centraliza la lógica de respaldo (default images, truncado de descripciones)
const seoData = processSEOMetadata(
	{
		title,
		description: description || '',
		image: ogImage,
		imageWidth: ogImageWidth,
		imageHeight: ogImageHeight,
		url: href,
		publishedAt,
		updatedAt,
		authorName,
		authorUrl
	},
	origin
);

// Lógica específica para Twitter Card
// Asegura que la imagen de Twitter sea absoluta (requisito de la plataforma)
const twitterImage = ensureAbsoluteUrl(ogImage || seoData.image, origin);
---

<!doctype html>
<html
	lang="es"
	class="font-primary-font h-full min-h-screen w-screen overflow-x-hidden scroll-smooth"
>
	<head>
		<!-- 
      ___           ___                             
     /  /\         /__/\          ___       ___     
    /  /:/         \  \:\        /  /\     /  /:/    
   /  /:/           \  \:\      /  /:/    /  /:/    
  /  /:/  ___   ___  \  \:\    /  /:/    /__/::\    
 /__/:/  /  /\ /__/\  \__\:\  /  /::\    \__\/\:\__ 
 \  \:\ /  /:/ \  \:\ /  /:/ /__/:/\:\      \  \:\/\
  \  \:\  /:/   \  \:\  /:/  \__\/  \:\      \__\::/
   \  \:\/:/     \  \:\/:/        \  \:\     /__/:/ 
    \  \::/       \  \::/          \__\/     \__\/  
     \__\/         \__\/                            
		-->
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="language" content="es" />
		<meta name="robots" content="index, follow" />

		<!-- SEO General -->
		<title>{title.charAt(0).toUpperCase() + title.slice(1)} | AC Colombia Lawyers</title>

		<meta name="description" content={seoData.description} />
		<meta
			name="keywords"
			content="abogados en Colombia, firma de abogados, recaudo de cartera, asesoría legal, servicios jurídicos, bufete de abogados, Centro Jurídico Internacional, CJI, protección legal empresas"
		/>
		<meta name="author" content="Centro Jurídico Internacional" />

		<!-- Open Graph - Protocolo para Redes Sociales -->
		<meta property="og:type" content={ogType} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={seoData.description} />
		<meta property="og:image" content={seoData.image} />
		<meta property="og:image:width" content={String(seoData.imageWidth)} />
		<meta property="og:image:height" content={String(seoData.imageHeight)} />
		<meta property="og:image:type" content="image/png" />
		<meta property="og:image:alt" content={title} />
		<meta property="og:url" content={href} />
		<meta property="og:site_name" content="Centro Jurídico Internacional" />
		{
			ogType === 'article' && publishedAt && (
				<meta property="article:published_time" content={publishedAt} />
			)
		}
		{
			ogType === 'article' && updatedAt && (
				<meta property="article:modified_time" content={updatedAt} />
			)
		}
		{ogType === 'article' && authorName && <meta property="article:author" content={authorName} />}

		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@CentroJuridicoI" />
		<meta name="twitter:creator" content="@CentroJuridicoI" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={seoData.description} />
		<meta name="twitter:image" content={twitterImage} />
		<meta name="twitter:image:alt" content={title} />

		<!-- URL Canónica -->
		<link rel="canonical" href={href} />

		<!-- Schema.org JSON-LD Global (Identidad de Organización + Sitio Web) -->
		<Fragment
			set:html={getSchemaScript(
				generateOrganizationSchema(
					{
						name: SITE_CONFIG.name,
						logo: SITE_CONFIG.logo,
						url: SITE_CONFIG.url,
						description: SITE_CONFIG.description,
						sameAs: SITE_CONFIG.sameAs
					},
					origin
				)
			)}
		/>
		<Fragment
			set:html={getSchemaScript(
				generateWebSiteSchema(
					{
						name: SITE_CONFIG.name,
						description: SITE_CONFIG.description,
						url: SITE_CONFIG.url,
						logo: SITE_CONFIG.logo,
						siteLanguage: SITE_CONFIG.siteLanguage
					},
					origin
				)
			)}
		/>

		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

		<!-- Preload crítico: logo del header -->
		<link rel="preload" href="/header/logo.svg" as="image" />

		<!-- Control de Caché -->
		<meta http-equiv="Cache-Control" content="max-age=31536000, immutable" />

		<!-- Preconexiones -->

		<!-- View Transitions y Analytics -->
		<meta name="view-transition" content="same-origin" />
		<ClientRouter />
		<Analytics />
		<SpeedInsights />
	</head>

	<body
		class="flex min-h-screen flex-col overflow-x-hidden bg-gray-50/30 transition-colors duration-300"
	>
		<!-- Header con animación suave -->
		<Header booleanHeader={booleanLayout} />

		<!-- Contenido principal con animaciones de entrada -->
		<main class="w-full flex-1">
			<div class="animate-fadeIn">
				<slot />
			</div>
		</main>
		<WhatsApp />
		<!-- Scroll To Top (Nivel raíz para manejo de Z-Index) -->
		<ScrollToTop client:idle />
		<SideButtons />

		<!-- Footer con transición suave -->
		<Footer />

		<!-- Elemento invisible en pantalla, visible solo al imprimir (fixed footer) -->
		<div class="print-footer-container hidden">
			<p>
				© Centro Jurídico Internacional - Documento Confidencial y Protegido por Derechos de Autor.
			</p>
			<p>Generado desde: {origin}</p>
		</div>
	</body><style>
		main {
			width: 100%;
			height: 100%;
			/* Agregar patrón de fondo personalizado aquí */
			background-color: #ffffffea;
			background-image: radial-gradient(rgba(0, 166, 61, 0.884) 1px, transparent 0);
			background-size: 30px 30px;
			background-position: -3px -3px;
		}

		/* Animaciones personalizadas */
		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(5px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		.animate-fadeIn {
			animation: fadeIn 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
		}

		/* Estilos de scroll suave */
		:global(html) {
			scroll-behavior: smooth;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		:global(body) {
			background-color: rgb(249 250 251 / 0.3);
		}

		/* Estilo de selección personalizado */
		:global(::selection) {
			background-color: rgb(187 247 208);
			color: rgb(20 83 45);
		}

		/* Mejora del scrollbar */
		:global(::-webkit-scrollbar) {
			width: 10px;
			background-color: transparent;
		}

		:global(::-webkit-scrollbar-thumb) {
			border-radius: 9999px;
			background-color: rgb(22 163 74 / 0.2);
			transition-property: color, background-color, border-color;
			transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
			transition-duration: 200ms;
		}

		:global(::-webkit-scrollbar-thumb:hover) {
			background-color: rgb(22 163 74 / 0.3);
		}

		/* Mejoras de enfoque para accesibilidad */
		:global(*:focus-visible) {
			outline: 2px solid transparent;
			outline-offset: 2px;
			--tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width)
				var(--tw-ring-offset-color);
			--tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width))
				var(--tw-ring-color);
			box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow);
			--tw-ring-color: rgb(34 197 94);
			--tw-ring-offset-width: 2px;
			--tw-ring-offset-color: white;
		}
	</style>
</html>

<script>
	// Manejo del título
	let title = document.title;
	document.addEventListener('astro:page-load', () => {
		return (title = document.title);
	});
	document.addEventListener('visibilitychange', () => {
		if (document.hidden) {
			document.title = 'Vuelve para estar siempre informado';
		} else {
			document.title = title;
		}
	});

	// Solo manejo del título en cambio de pestañas
</script>
