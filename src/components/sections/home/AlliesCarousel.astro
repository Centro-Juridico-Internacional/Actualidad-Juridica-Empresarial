---
import Titles from '@/components/ui/Titles.astro';

/**
 * AlliesCarousel.astro
 * Marquesina de desplazamiento infinito para logos de aliados y socios estratégicos.
 */

const allies = [
	{
		name: 'Apple',
		logo: 'https://cdn.worldvectorlogo.com/logos/apple-13.svg',
		url: 'https://apple.com'
	},
	{
		name: 'Google',
		logo: 'https://cdn.worldvectorlogo.com/logos/google-g-2015.svg',
		url: 'https://google.com'
	},
	{
		name: 'Microsoft',
		logo: 'https://cdn.worldvectorlogo.com/logos/microsoft-5.svg',
		url: 'https://microsoft.com'
	},
	{
		name: 'Amazon',
		logo: 'https://cdn.worldvectorlogo.com/logos/logo-amazon.svg',
		url: 'https://amazon.com'
	},
	{
		name: 'Facebook',
		logo: 'https://cdn.worldvectorlogo.com/logos/facebook.svg',
		url: 'https://facebook.com'
	},
	{
		name: 'Tesla',
		logo: 'https://cdn.worldvectorlogo.com/logos/tesla-pure.svg',
		url: 'https://tesla.com'
	},
	{ name: 'X', logo: 'https://cdn.worldvectorlogo.com/logos/x-2.svg' }, // No URL example
	{
		name: 'Netflix',
		logo: 'https://cdn.worldvectorlogo.com/logos/netflix-logo-icon.svg',
		url: 'https://netflix.com'
	},
	{
		name: 'Spotify',
		logo: 'https://cdn.worldvectorlogo.com/logos/spotify-2.svg',
		url: 'https://spotify.com'
	},
	{
		name: 'Nike',
		logo: 'https://cdn.worldvectorlogo.com/logos/nike-8.svg',
		url: 'https://nike.com'
	}
];

// Duplicado de lista para asegurar un desplazamiento infinito fluido (Sin cortes visuales)
// const doubleAllies = [...allies, ...allies];
---

<section class="allies-carousel-section my-16" id="alliesSection">
	<Titles text="Nuestros Aliados Estratégicos" />

	<div class="marquee">
		<!-- Primer bloque de contenido -->
		<div class="marquee-content">
			{
				allies.map((ally) => (
					<div class="ally-item">
						{ally.url ? (
							<a
								href={ally.url}
								target="_blank"
								rel="noopener noreferrer"
								class="ally-link"
								title={ally.name}
							>
								<img src={ally.logo} alt={ally.name} loading="lazy" />
							</a>
						) : (
							<div class="ally-link no-click" title={ally.name}>
								<img src={ally.logo} alt={ally.name} loading="lazy" />
							</div>
						)}
					</div>
				))
			}
		</div>

		<!-- Bloque duplicado para el efecto de loop infinito (Oculto para lectores de pantalla) -->
		<div class="marquee-content" aria-hidden="true">
			{
				allies.map((ally) => (
					<div class="ally-item">
						{ally.url ? (
							<a
								href={ally.url}
								target="_blank"
								rel="noopener noreferrer"
								class="ally-link"
								title={ally.name}
								tabindex="-1"
							>
								<img src={ally.logo} alt={ally.name} loading="lazy" />
							</a>
						) : (
							<div class="ally-link no-click" title={ally.name}>
								<img src={ally.logo} alt={ally.name} loading="lazy" />
							</div>
						)}
					</div>
				))
			}
		</div>
	</div>
</section>

<script>
	const marquee = document.querySelector('.marquee') as HTMLElement;
	const content = document.querySelector('.marquee-content') as HTMLElement;

	if (marquee && content) {
		let isDragging = false;
		let startX = 0;
		let currentX = 0;

		const handleStart = (e: MouseEvent | TouchEvent) => {
			isDragging = true;
			startX = 'touches' in e ? e.touches[0].pageX : (e as MouseEvent).pageX;

			const style = window.getComputedStyle(content);
			// @ts-ignore
			const matrix = new WebKitCSSMatrix(style.transform);
			currentX = matrix.m41;

			marquee.style.cursor = 'grabbing';
			marquee.classList.add('is-dragging');
		};

		// Gestión del movimiento mediante gestos (Drag/Swipe) para mejorar la interactividad
		const handleMove = (e: MouseEvent | TouchEvent) => {
			if (!isDragging) return;
			const x = 'touches' in e ? e.touches[0].pageX : (e as MouseEvent).pageX;
			const walk = (x - startX) * 1.2;

			content.style.animationPlayState = 'paused';
			content.style.transform = `translateX(${currentX + walk}px)`;
		};

		const handleEnd = () => {
			if (!isDragging) return;
			isDragging = false;
			marquee.style.cursor = 'grab';
			marquee.classList.remove('is-dragging');

			setTimeout(() => {
				content.style.animationPlayState = '';
				content.style.transform = '';
			}, 50);
		};

		marquee.addEventListener('mousedown', handleStart);
		marquee.addEventListener('touchstart', handleStart, { passive: true });

		window.addEventListener('mousemove', handleMove);
		window.addEventListener('touchmove', handleMove, { passive: false });

		window.addEventListener('mouseup', handleEnd);
		window.addEventListener('touchend', handleEnd);
	}
</script>

<style>
	.allies-carousel-section {
		overflow: hidden;
		background: transparent;
	}

	.marquee {
		position: relative;
		display: flex;
		overflow: hidden;
		user-select: none;
		gap: 4rem;
		mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
		-webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
		cursor: grab;
	}

	.marquee.is-dragging .marquee-content {
		animation: none !important;
	}

	.marquee-content {
		flex-shrink: 0;
		display: flex;
		align-items: center;
		justify-content: flex-start;
		gap: 4rem;
		animation: scroll 40s linear infinite;
	}

	.marquee:hover .marquee-content {
		animation-play-state: paused;
	}

	.ally-item {
		flex-shrink: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 120px;
		height: 80px;
	}

	.ally-link {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		height: 100%;
		transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		filter: grayscale(1);
		opacity: 0.6;
	}

	.ally-link:hover {
		filter: grayscale(0);
		opacity: 1;
		transform: scale(1.15);
	}

	.no-click {
		cursor: default;
	}

	.ally-link img {
		max-width: 80%;
		max-height: 50%;
		object-fit: contain;
		pointer-events: none;
	}

	@keyframes scroll {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(calc(-100% - 4rem));
		}
	}

	@media (max-width: 768px) {
		.ally-item {
			width: 100px;
		}
		.marquee {
			gap: 2.5rem;
		}
		.marquee-content {
			gap: 2.5rem;
			animation-duration: 30s;
		}
		@keyframes scroll {
			from {
				transform: translateX(0);
			}
			to {
				transform: translateX(calc(-100% - 2.5rem));
			}
		}
	}
</style>
