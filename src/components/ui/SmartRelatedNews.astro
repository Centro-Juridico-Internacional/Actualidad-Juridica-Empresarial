---
// Importaciones de API Interna
import { searchNews } from '@/lib/api/search';
import { getLatestNews } from '@/lib/api/news';
import type { NewsArticle } from '@/lib/api/news';

// Propiedades
interface Props {
	currentSlug: string;
	currentTitle: string;
	categorySlugs?: string[];
	limit?: number;
}

const { currentSlug, currentTitle, categorySlugs = [], limit = 4 } = Astro.props;

// 1. Extraer palabras clave del título (eliminando palabras vacías/stopwords)
const stopWords = [
	'de',
	'la',
	'el',
	'en',
	'y',
	'a',
	'los',
	'se',
	'del',
	'las',
	'por',
	'un',
	'una',
	'con',
	'no',
	'sus',
	'su',
	'para',
	'al',
	'lo',
	'como',
	'más',
	'pero',
	'o',
	'le',
	'ir',
	'ese',
	'si',
	'me',
	'ya',
	'todo',
	'esta',
	'son',
	'mi',
	'sin',
	'sobre',
	'este',
	'tambien',
	'nos',
	'entre',
	'cuando',
	'muy',
	'desde',
	'estos',
	'nosotros',
	'durante',
	'uno',
	'ni',
	'contra',
	'ese',
	'eso',
	'mí',
	'qué',
	'otro',
	'él',
	'cual',
	'poco',
	'ella',
	'estar',
	'haber',
	'cuyo',
	'donde'
];

const getKeywords = (text: string) => {
	return text
		.toLowerCase()
		.replace(/[^\w\s\u00C0-\u00FF]/g, '') // Eliminar puntuación
		.split(/\s+/)
		.filter((w) => w.length > 3 && !stopWords.includes(w))
		.slice(0, 3) // Tomar las top 3 palabras clave
		.join(' ');
};

const keywords = getKeywords(currentTitle);

// 2. Buscar noticias relacionadas por palabras clave
let relatedNews: NewsArticle[] = [];

try {
	if (keywords) {
		const results = await searchNews({ query: keywords, pageSize: limit + 2 }); // Pedir extra para filtrar actual
		relatedNews = results.products.filter((n) => n.slug !== currentSlug).slice(0, limit);
	}
} catch (e) {
	console.error('Error matching keywords relation:', e);
}

// 3. Si no hay suficientes resultados, rellenar con coincidencias de Categoría (Respaldo)
if (relatedNews.length < limit) {
	try {
		const moreNeeded = limit - relatedNews.length;
		// No excluimos currentSlug aquí en el fetch si lo manejamos en el filtro,
		// pero getLatestNews maneja el parámetro de exclusión.
		const categoryNews = await getLatestNews(moreNeeded + 2, currentSlug, categorySlugs);

		// Mezclar sin duplicados
		const existingSlugs = new Set(relatedNews.map((n) => n.slug));
		for (const news of categoryNews) {
			if (!existingSlugs.has(news.slug) && relatedNews.length < limit) {
				relatedNews.push(news);
				existingSlugs.add(news.slug);
			}
		}
	} catch (e) {
		console.error('Error matching category relation:', e);
	}
}
---

<div class="grid grid-cols-1 gap-6">
	{
		relatedNews.map((news: any) => (
			<div class="group relative flex w-full items-start gap-3 border-b border-gray-100 pb-4 transition-colors hover:border-green-200 sm:gap-4 sm:pb-6">
				{/* Imagen responsive con aspect ratio fijo */}
				<div class="relative h-20 w-20 shrink-0 overflow-hidden rounded-xl sm:h-24 sm:w-24">
					<img
						src={news.image}
						alt={news.title}
						class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
						loading="lazy"
						decoding="async"
					/>
					<div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100" />
				</div>

				{/* Contenido con truncamiento inteligente */}
				<div class="flex min-w-0 flex-1 flex-col gap-1">
					{/* Categoría */}
					<a
						href={`/categorias/${news.categories[0]?.toLowerCase()}`}
						class="inline-block w-fit text-xs font-medium text-green-600 transition-colors first-letter:uppercase hover:text-green-700"
					>
						{news.categories[0]?.trim()}
					</a>

					{/* Título con truncamiento a 2 líneas */}
					<h3 class="line-clamp-2 text-sm leading-tight font-semibold text-gray-900 decoration-green-500 decoration-2 group-hover:underline sm:text-base">
						<a href={`/noticia/${news.slug}`} class="hover:text-green-700">
							{news.title}
						</a>
					</h3>

					{/* Fecha */}
					<time class="mt-1 text-xs text-gray-500">{news.day}</time>
				</div>
			</div>
		))
	}

	{
		relatedNews.length === 0 && (
			<p class="text-sm text-gray-500 italic">No hay noticias relacionadas por ahora.</p>
		)
	}
</div>
