---
import { BlocksRenderer } from '@strapi/blocks-react-renderer';
import YouTubeLite from '@/components/features/media/YouTubeLite';
import { truncateBlocks } from '@/utils/truncateBlocks';

const { product, truncateWords = 30 } = Astro.props;

const autorSlug = product.autorName
	? `/autores/${product.autorName.toLowerCase().replace(/\s+/g, '_')}`
	: '#';

const { blocks, truncated } = truncateBlocks(product.contenido, truncateWords);
---

<article class="group relative flex h-full flex-col overflow-hidden rounded-2xl bg-white shadow-md">
	<!-- Imagen con overlay gradual (altura consistente) -->
	<div class="relative aspect-[16/9] w-full overflow-hidden">
		<img
			src={product.image}
			alt={`${product.titulo} imagen`}
			class="h-full w-full object-cover transition-transform duration-700 ease-in-out"
			loading="lazy"
			decoding="async"
		/>
		<div
			class="pointer-events-none absolute inset-0 bg-gradient-to-t from-green-200/45 via-transparent to-transparent opacity-0 transition-opacity duration-[900ms] ease-[cubic-bezier(.22,1,.36,1)] group-hover:opacity-100 after:absolute after:inset-x-6 after:bottom-4 after:h-4 after:translate-y-6 after:transform-gpu after:rounded-full after:bg-black/20 after:opacity-0 after:blur-md after:transition-all after:delay-[150ms] after:duration-[900ms] after:ease-[cubic-bezier(.22,1,.36,1)] after:will-change-transform after:content-[''] group-hover:after:translate-y-0 group-hover:after:opacity-100"
		>
		</div>
	</div>

	<!-- Contenido -->
	<div class="flex min-h-0 flex-1 flex-col p-6">
		<!-- Categorías y Fecha -->
		<div class="mb-4 flex flex-wrap items-center gap-2">
			<span
				class="inline-flex items-center rounded-full bg-green-50 px-3 py-1 text-xs font-medium text-green-700"
			>
				{product.dia} • {product.hora}
			</span>
			{
				product.categorias.map((item: any) => (
					<a
						href={`/categorias/${item}`}
						class="inline-block items-center rounded-full bg-gray-50 px-3 py-1 text-xs font-medium text-gray-600 transition-colors first-letter:uppercase hover:bg-green-50 hover:text-green-700"
					>
						{item}
					</a>
				))
			}
		</div>

		<!-- Título -->
		<h1
			class="mb-2 text-xl leading-tight font-bold text-gray-900 decoration-green-500 decoration-2 group-hover:underline"
		>
			<a href={`/noticia/${product.slug}`}>{product.titulo}</a>
		</h1>

		<!-- Extracto con clamp para no romper alturas -->
		<div class="mb-4 line-clamp-3 text-sm leading-relaxed text-gray-600 lg:line-clamp-4">
			<BlocksRenderer content={blocks} client:load />
		</div>

		<!-- Video de YouTube si existe (altura consistente) -->
		{
			product.UrlYoutube && (
				<div
					class="mb-4 aspect-video overflow-hidden rounded-xl shadow-sm"
					data-videoid={product.UrlYoutube}
				>
					<YouTubeLite
						videoid={product.UrlYoutube}
						title={product.titulo}
						client:visible
						transition:persist
					/>
				</div>
			)
		}

		<!-- Empuja autor al fondo para que la card llene la fila -->
		<div class="mt-auto flex items-center gap-3 border-t border-gray-100 pt-4">
			<a
				href={autorSlug}
				title={product.autorName}
				class="relative overflow-hidden rounded-full ring-2 ring-gray-100 transition-all hover:ring-green-200"
			>
				<img
					src={product.autorAvatar}
					alt={product.autorName}
					class="h-10 w-10 object-cover"
					loading="lazy"
					decoding="async"
				/>
			</a>
			<div class="flex flex-col">
				<a href={autorSlug} class="text-sm font-medium text-gray-900 hover:text-green-600">
					{product.autorName}
				</a>
				<span class="text-xs text-gray-500">Autor</span>
			</div>
		</div>
	</div>
</article>
